<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processando Autenticação</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      color: #333;
    }
    .container {
      text-align: center;
      padding: 2rem;
      background-color: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 100%;
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 1rem;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #0070f3;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .error {
      color: #e53e3e;
      margin-top: 1rem;
      padding: 1rem;
      background-color: #fed7d7;
      border-radius: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner"></div>
    <h1>Processando Autenticação</h1>
    <p id="status">Redirecionando...</p>
    <div id="error" class="error" style="display: none;"></div>
  </div>

  <script>
    (function() {
      // Array para controlar timeouts ativos
      let activeTimeouts = [];

      // Função para criar timeout controlado
      function createControlledTimeout(callback, delay) {
        const timeoutId = setTimeout(() => {
          // Remover da lista quando executar
          activeTimeouts = activeTimeouts.filter(id => id !== timeoutId);
          callback();
        }, delay);
        
        // Adicionar à lista de timeouts ativos
        activeTimeouts.push(timeoutId);
        return timeoutId;
      }

      // Função para limpar todos os timeouts
      function clearAllTimeouts() {
        activeTimeouts.forEach(id => clearTimeout(id));
        activeTimeouts = [];
      }

      // Função para atualizar o status na página
      function updateStatus(message) {
        document.getElementById('status').textContent = message;
      }

      // Função para mostrar erro
      function showError(message) {
        const errorEl = document.getElementById('error');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        updateStatus('Erro na autenticação');
      }

      // Função para extrair parâmetros da URL
      function getUrlParams() {
        const params = {};
        const queryString = window.location.search.substring(1);
        const pairs = queryString.split('&');
        
        for (let i = 0; i < pairs.length; i++) {
          const pair = pairs[i].split('=');
          params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
        }
        
        return params;
      }

      // Função para redirecionar para o app principal com o código
      function redirectToMainApp(code) {
        // Sanitizar URL para prevenir open redirect
        if (!code || typeof code !== 'string' || code.length < 10) {
          console.error('Código inválido para redirecionamento');
          showError('Código de autenticação inválido');
          return;
        }
        
        window.location.href = `/auth/callback?code=${encodeURIComponent(code)}`;
      }

      // Função principal
      function handleOAuth() {
        try {
          updateStatus('Verificando código de autenticação...');
          
          // Obter parâmetros da URL
          const params = getUrlParams();
          const code = params.code;
          const error = params.error;
          
          // Verificar se há erro
          if (error) {
            showError(`Erro retornado pelo provedor de autenticação: ${error}`);
            createControlledTimeout(() => {
              window.location.href = '/login?error=' + encodeURIComponent(error);
            }, 3000);
            return;
          }
          
          // Verificar se existe um código
          if (!code) {
            showError('Código de autenticação não encontrado na URL');
            createControlledTimeout(() => {
              window.location.href = '/login?error=' + encodeURIComponent('Código de autenticação ausente');
            }, 3000);
            return;
          }
          
          // Redirecionar para o callback do app principal
          updateStatus('Código encontrado. Redirecionando...');
          console.log('Código OAuth recebido:', code.substring(0, 10) + '...');
          createControlledTimeout(() => redirectToMainApp(code), 500);
        } catch (err) {
          showError(`Erro inesperado: ${err.message}`);
          console.error('Erro ao processar autenticação:', err);
          createControlledTimeout(() => {
            window.location.href = '/login?error=' + encodeURIComponent('Erro inesperado durante a autenticação');
          }, 3000);
        }
      }

      // Limpar timeouts quando a página for descarregada
      window.addEventListener('beforeunload', clearAllTimeouts);

      // Executar o handler quando a página carregar
      window.onload = handleOAuth;
    })();
  </script>
</body>
</html> 