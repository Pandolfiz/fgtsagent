<%- include('../partials/header') %>
<%- include('../partials/sidebar') %>

<!-- Conteúdo principal -->
<main class="content">
  <%- include('../partials/topbar') %>

  <!-- Cabeçalho da página -->
  <div class="py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center">
      <div class="mb-3 mb-lg-0">
        <h1 class="h3 mb-0">Chaves de API</h1>
        <span class="d-inline-block text-muted mb-3">
          Gerencie suas chaves de API para acesso programático à plataforma.
        </span>
      </div>
      <div>
        <button class="btn btn-primary" id="createApiKeyBtn">
          <i class="fas fa-plus-circle me-2"></i>Nova Chave de API
        </button>
      </div>
    </div>
  </div>

  <!-- Alertas e mensagens -->
  <div id="alertContainer" class="mb-4"></div>

  <!-- Container para a mensagem de novo token -->
  <div id="newKeyContainer" class="mb-4 d-none">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-key me-2"></i>Nova Chave de API Criada
          </h5>
          <button type="button" class="btn-close btn-close-white" id="closeNewKeyBtn" aria-label="Fechar"></button>
        </div>
      </div>
      <div class="card-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Importante:</strong> Anote sua chave de API agora. Por segurança, ela não será exibida novamente.
        </div>
        
        <div class="mb-3">
          <label class="form-label">Nome da Chave:</label>
          <div class="form-control-plaintext" id="newKeyName">-</div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Chave de API:</label>
          <div class="input-group">
            <input type="text" class="form-control font-monospace bg-light" id="newKeyValue" readonly>
            <button class="btn btn-outline-secondary" type="button" id="copyKeyBtn">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <small class="form-text text-muted">
            Use esta chave no cabeçalho <code>X-User-API-Key</code> de suas requisições.
          </small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Expira em:</label>
          <div class="form-control-plaintext" id="newKeyExpiry">-</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de chaves de API -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Suas Chaves de API</h5>
      <div class="spinner-border text-primary spinner-border-sm d-none" id="keysLoadingSpinner" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="bg-light">
            <tr>
              <th class="border-top-0">Nome</th>
              <th class="border-top-0">Prefixo</th>
              <th class="border-top-0">Criada em</th>
              <th class="border-top-0">Expira em</th>
              <th class="border-top-0">Último uso</th>
              <th class="border-top-0">Status</th>
              <th class="border-top-0 text-end">Ações</th>
            </tr>
          </thead>
          <tbody id="apiKeysList">
            <!-- Lista de chaves será preenchida via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-white px-3 py-3" id="noKeysMessage">
      <div class="text-center text-muted">
        Nenhuma chave de API encontrada. Clique em "Nova Chave de API" para criar.
      </div>
    </div>
  </div>

  <!-- Modal para criar nova chave API -->
  <div class="modal fade" id="createApiKeyModal" tabindex="-1" role="dialog" aria-labelledby="createApiKeyModalTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createApiKeyModalTitle">Nova Chave de API</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <form id="createApiKeyForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="apiKeyName" class="form-label">Nome da Chave <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="apiKeyName" name="name" required 
                     placeholder="Ex: Integração Website" minlength="3" maxlength="100">
              <small class="form-text text-muted">Um nome descritivo para identificar esta chave (3-100 caracteres).</small>
            </div>
            
            <div class="mb-3">
              <label for="apiKeyExpiry" class="form-label">Validade</label>
              <select class="form-select" id="apiKeyExpiry" name="expiresInDays">
                <option value="30">30 dias</option>
                <option value="90">90 dias</option>
                <option value="365" selected>1 ano</option>
                <option value="730">2 anos</option>
                <option value="1825">5 anos</option>
                <option value="3650">10 anos</option>
              </select>
              <small class="form-text text-muted">Período de validade da chave antes de expirar.</small>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Esta chave terá acesso às mesmas organizações e recursos que você.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="submitApiKeyBtn">
              <span class="spinner-border spinner-border-sm d-none" id="createKeySpinner" role="status" aria-hidden="true"></span>
              Criar Chave
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para confirmar revogação -->
  <div class="modal fade" id="revokeKeyModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Revogar Chave de API</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja revogar esta chave de API?</p>
          <p><strong>Nome:</strong> <span id="revokeKeyName"></span></p>
          <p><strong>Prefixo:</strong> <span id="revokeKeyPrefix"></span></p>
          
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Esta ação é irreversível. Após a revogação, a chave não poderá mais ser utilizada.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmRevokeBtn">
            <span class="spinner-border spinner-border-sm d-none" id="revokeKeySpinner" role="status" aria-hidden="true"></span>
            Revogar Chave
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar nome da chave -->
  <div class="modal fade" id="editKeyNameModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Nome da Chave</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <form id="editKeyNameForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="editKeyNameInput" class="form-label">Nome da Chave <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editKeyNameInput" name="name" required 
                     placeholder="Ex: Integração Website" minlength="3" maxlength="100">
              <small class="form-text text-muted">Um nome descritivo para identificar esta chave (3-100 caracteres).</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="saveKeyNameBtn">
              <span class="spinner-border spinner-border-sm d-none" id="editKeyNameSpinner" role="status" aria-hidden="true"></span>
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>
</main>

<%- include('../partials/scripts') %> 