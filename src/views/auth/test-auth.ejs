<%- include('../layout', { title }) %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0"><i class="bi bi-shield-check me-2"></i>Teste de Autenticação</h2>
        </div>
        <div class="card-body">
          <% if (error) { %>
            <div class="alert alert-danger" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <strong>Erro:</strong> <%= error %>
            </div>
            
            <div class="mt-4">
              <h5>Possíveis soluções:</h5>
              <ol>
                <li>Faça login novamente para obter um token válido</li>
                <li>Verifique se os cookies estão sendo definidos corretamente</li>
                <li>Se você está usando ngrok, tente o fluxo alternativo em <code>/auth/google-ngrok</code></li>
              </ol>
            </div>
            
            <div class="d-grid gap-2 mt-4">
              <a href="/auth/login" class="btn btn-primary">
                <i class="bi bi-box-arrow-in-right me-2"></i>Ir para a página de login
              </a>
              <a href="/auth/auth-diagnostics" class="btn btn-secondary">
                <i class="bi bi-tools me-2"></i>Executar diagnóstico
              </a>
            </div>
          <% } else if (isAuthenticated) { %>
            <div class="alert alert-success" role="alert">
              <i class="bi bi-check-circle-fill me-2"></i>
              <strong>Autenticado!</strong> Você está logado com sucesso.
            </div>
            
            <div class="mt-4">
              <h5>Informações do Usuário:</h5>
              <div class="table-responsive">
                <table class="table table-striped">
                  <tr>
                    <th style="width: 30%">ID do Usuário:</th>
                    <td><code><%= user.id %></code></td>
                  </tr>
                  <tr>
                    <th>Email:</th>
                    <td><%= user.email %></td>
                  </tr>
                  <tr>
                    <th>Criado em:</th>
                    <td><%= new Date(user.createdAt).toLocaleString('pt-BR') %></td>
                  </tr>
                </table>
              </div>
              
              <% if (user.profile) { %>
                <h5 class="mt-4">Perfil:</h5>
                <div class="table-responsive">
                  <table class="table table-striped">
                    <tr>
                      <th style="width: 30%">Nome:</th>
                      <td><%= user.profile.first_name %> <%= user.profile.last_name %></td>
                    </tr>
                    <% if (user.profile.avatar_url) { %>
                      <tr>
                        <th>Avatar:</th>
                        <td>
                          <img src="<%= user.profile.avatar_url %>" alt="Avatar" class="rounded-circle" style="width: 48px; height: 48px;">
                        </td>
                      </tr>
                    <% } %>
                  </table>
                </div>
              <% } %>
              
              <h5 class="mt-4">Metadados:</h5>
              <div class="table-responsive">
                <table class="table table-striped">
                  <% if (Object.keys(user.metadata).length > 0) { %>
                    <% for(const [key, value] of Object.entries(user.metadata)) { %>
                      <tr>
                        <th style="width: 30%"><%= key %>:</th>
                        <td><%= typeof value === 'object' ? JSON.stringify(value) : value %></td>
                      </tr>
                    <% } %>
                  <% } else { %>
                    <tr>
                      <td colspan="2" class="text-center">Nenhum metadado disponível</td>
                    </tr>
                  <% } %>
                </table>
              </div>
              
              <h5 class="mt-4">Token:</h5>
              <div class="table-responsive">
                <table class="table table-striped">
                  <tr>
                    <th style="width: 30%">Valor:</th>
                    <td><code><%= token.value %></code> <small class="text-muted">(truncado para segurança)</small></td>
                  </tr>
                  <% if (token.expiresAt) { %>
                    <tr>
                      <th>Expira em:</th>
                      <td><%= new Date(token.expiresAt).toLocaleString('pt-BR') %></td>
                    </tr>
                  <% } %>
                </table>
              </div>
            </div>
            
            <div class="d-grid gap-2 mt-4">
              <a href="/dashboard" class="btn btn-primary">
                <i class="bi bi-speedometer2 me-2"></i>Ir para o Dashboard
              </a>
              <a href="/auth/logout" class="btn btn-outline-danger">
                <i class="bi bi-box-arrow-right me-2"></i>Fazer Logout
              </a>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div> 